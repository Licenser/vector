---
last_modified_on: "2020-04-05"
component_title: "Lua"
description: "The Vector `lua` transform accepts and outputs `log` and `metric` events allowing you to transform events with a full embedded Lua engine."
event_types: ["log","metric"]
function_category: "program"
issues_url: https://github.com/timberio/vector/issues?q=is%3Aopen+is%3Aissue+label%3A%22transform%3A+lua%22
sidebar_label: "lua|[\"log\",\"metric\"]"
source_url: https://github.com/timberio/vector/tree/master/src/transforms/lua
status: "beta"
title: "Lua Transform"
---

import Fields from '@site/src/components/Fields';
import Field from '@site/src/components/Field';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

The Vector `lua` transform
accepts and outputs [`log`][docs.data-model.log] and
[`metric`][docs.data-model.metric] events allowing you to transform events with
a full embedded [Lua][urls.lua] engine.

<!--
     THIS FILE IS AUTOGENERATED!

     To make changes please edit the template located at:

     website/docs/reference/transforms/lua.md.erb
-->

## Configuration

<Tabs
  block={true}
  defaultValue="common"
  values={[{"label":"Common","value":"common"},{"label":"Advanced","value":"advanced"}]}>

<TabItem value="common">

```toml title="vector.toml"
[transforms.my_transform_id]
  # General
  version = "2" # required

  # Hooks
  hooks.process = """
  function (event, emit)
    event.log.field = "value" -- set value of a field
    event.log.another_field = nil -- remove field
    event.log.first, event.log.second = nil, event.log.first -- rename field
    emit(event) -- emit the processed event
  end
  """ # required
```

</TabItem>
<TabItem value="advanced">

```toml title="vector.toml"
[transforms.my_transform_id]
  # General
  version = "2" # required
  search_dirs = ["/etc/vector/lua"] # optional, no default

  # Timers
  timers.handler = "custom_module.timer_handler" # required
  timers.interval_seconds = 1 # required, seconds

  # Hooks
  hooks.process = """
  function (event, emit)
    event.log.field = "value" -- set value of a field
    event.log.another_field = nil -- remove field
    event.log.first, event.log.second = nil, event.log.first -- rename field
    emit(event) -- emit the processed event
  end
  """ # required
  hooks.init = "custom_module.hook_init" # optional, no default
  hooks.shutdown = "custom_module.hook_shutdown" # optional, no default
```

</TabItem>
</Tabs>

<Fields filters={true}>
<Field
  common={true}
  defaultValue={null}
  enumValues={null}
  examples={[]}
  groups={[]}
  name={"hooks"}
  path={null}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"table"}
  unit={null}
  warnings={[]}
  >

### hooks

Configures hooks handlers.



<Fields filters={false}>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={["custom_module.hook_init","function (emit)\n  local f = io.popen (\"/bin/hostname\") -- run \"hostname\" command to determine the hostname\n  hostname = f:read(\"*a\") or \"\" -- set a global variable which can be used in other hooks\n  f:close() -- close the pipe\n\n  emit {\n    log = {\n      message = \"initialized!\"\n    }\n  }\nend"]}
  groups={[]}
  name={"init"}
  path={"hooks"}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"string"}
  unit={null}
  warnings={[]}
  >

#### init

A function which is called when the first event comes, before calling
`hooks.process`




</Field>
<Field
  common={true}
  defaultValue={null}
  enumValues={null}
  examples={["function (event, emit)\n  event.log.field = \"value\" -- set value of a field\n  event.log.another_field = nil -- remove field\n  event.log.first, event.log.second = nil, event.log.first -- rename field\n  emit(event) -- emit the processed event\nend","custom_module.hook_process"]}
  groups={[]}
  name={"process"}
  path={"hooks"}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  warnings={[]}
  >

#### process

A function which is called for each incoming event. It can produce new events
using `emit` function.




</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={["custom_module.hook_shutdown","function (emit)\n  emit {\n    log = {\n      message = \"shutting down...\"\n    }\n  }\nend"]}
  groups={[]}
  name={"shutdown"}
  path={"hooks"}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"string"}
  unit={null}
  warnings={[]}
  >

#### shutdown

A function which is called when Vector is stopped. It can produce new events
using `emit` function.




</Field>
</Fields>

</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={[["/etc/vector/lua"]]}
  groups={[]}
  name={"search_dirs"}
  path={null}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"[string]"}
  unit={null}
  warnings={[]}
  >

### search_dirs

A list of directories search when loading a Lua file via the `require` function.

 See [Search Directories](#search-directories) for more info.


</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={[]}
  groups={[]}
  name={"timers"}
  path={null}
  relevantWhen={null}
  required={false}
  templateable={false}
  type={"[table]"}
  unit={null}
  warnings={[]}
  >

### timers

Configures timers which are executed periodically at given interval



<Fields filters={false}>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={["custom_module.timer_handler","function (emit)\n  emit {\n    log = {\n      message = \"current time: \" .. os.date()\n    }\n  }\nend"]}
  groups={[]}
  name={"handler"}
  path={"timers"}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  warnings={[]}
  >

#### handler

Defines a handler function which is executed periodially at [`interval_seconds`](#interval_seconds).
It can produce new events using`emit` function.




</Field>
<Field
  common={false}
  defaultValue={null}
  enumValues={null}
  examples={[1,10,30]}
  groups={[]}
  name={"interval_seconds"}
  path={"timers"}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"integer"}
  unit={"seconds"}
  warnings={[]}
  >

#### interval_seconds

Defines the interval at which the timer handler would be executed.




</Field>
</Fields>

</Field>
<Field
  common={true}
  defaultValue={null}
  enumValues={{"2":"Lua transform API version 2"}}
  examples={["2"]}
  groups={[]}
  name={"version"}
  path={null}
  relevantWhen={null}
  required={true}
  templateable={false}
  type={"string"}
  unit={null}
  warnings={[]}
  >

### version

Transform API version. Specifying this version ensures that Vector does not
break backward compatibility.




</Field>
</Fields>

## Output

<Tabs
  block={true}
  defaultValue="add_fields"
  values={[
    { label: 'Add Fields', value: 'add_fields', },
    { label: 'Remove Fields', value: 'remove_fields', },
    { label: 'Drop Event', value: 'drop_event', },
  ]
}>

<TabItem value="add_fields">

Add a field to an event. Supply this as the `hooks.proces` value:

```lua
function (event, emit)
  # Add root level field
  event.log.new_field = "new value"
  # Add nested field
  event.log.nested.field = "nested value"

  emit(event)
end
```

</TabItem>
<TabItem value="remove_fields">

Remove a field from an event. Supply this as the `hooks.process` value:

```lua
function (event, emit)
  # Remove root level field
  event.log.field = nil
  # Remove nested field
  event.log.nested.field = nil

  emit(event)
end
```

</TabItem>
<TabItem value="drop_event">

Drop an event entirely. Supply this as the `hooks.process` value:

```lua
function (event, emit)
  # Drop event entirely by not calling the emitting function
end
```

</TabItem>
</Tabs>

## How It Works

### Environment Variables

Environment variables are supported through all of Vector's configuration.
Simply add `${MY_ENV_VAR}` in your Vector configuration file and the variable
will be replaced before being evaluated.

You can learn more in the
[Environment Variables][docs.configuration#environment-variables] section.

### Dropping Events

To drop events, simply do not call the emitting function with it. For example:

```toml title="vector.toml"
hooks.process = """\
function (event, emit)
  if not event["message"].match(str, "debug") then
    emit(event)
  end
end\
"""
```

### Representation of Events

Events are represented as tables in Lua. Vector uses
[externally tagged representation][urls.externally_tagged_representation] to
encode both log and metric events in a consistent fashion:

* [Log events][docs.about.data-model.log] are represented as values of a key
  named `log`.
* [Metric events][docs.about.data-model.metric] are represnted as values of a
  key named `metric`.

For instance, a typical log event produced by the [`stdin`][docs.sources.stdin]
source could have been created programmatically using the following code:

```lua
event = {
  log = {
    host = "localhost",
    message = "the message",
    timestamp = os.date("!*t")
  }
}
```

A typical metric event could have been created programmatically in a similar way:

<Tabs
  defaultValue="counter"
  select={true}
  urlKey="metric_kind"
  values={[
    { label: 'Counter', value: 'counter', },
    { label: 'Gauge', value: 'gauge', },
    { label: 'Set', value: 'set', },
    { label: 'Distribution', value: 'distribution', },
    { label: 'Aggregated Histogram', value: 'aggregated_histogram', },
    { label: 'Aggregated Summary', value: 'aggregated_summary', },
  ]
}>
<TabItem value="counter">

```lua
event = {
  metric = {
    name = "login.count",
    timestamp = os.date("!*t"),
    kind = "absolute",
    tags = {
      host = "my.host.example"
    },
    counter = {
      value: 24.2
    }
  }
}
```

</TabItem>
<TabItem value="gauge">

```lua
event = {
  metric = {
    name = "memory_rss",
    timestamp = os.date("!*t"),
    kind = "absolute",
    tags = {
      host = "my.host.example"
    },
    gauge = {
      value = 512.0
    }
  }
}
```

</TabItem>
<TabItem value="set">

```lua
event = {
  metric = {
    name = "user_names",
    timestamp = os.date("!*t"),
    kind = "absolute",
    tags = {
      host = "my.host.example"
    },
    set = {
      values = {"value1", "value2"}
    }
  }
}
```

</TabItem>
<TabItem value="distribution">

```javascript
event = {
  metric = {
    name = "response_time_ms",
    timestamp = os.date("!*t"),
    kind = "absolute",
    tags = {
      host = "my.host.example"
    },
    distribution = {
      values = {2.21, 5.46, 10.22},
      sample_rates = {5, 2, 5}
    }
  }
}
```

</TabItem>
<TabItem value="aggregated_histogram">

```lua
event = {
  metric = {
    name = "response_time_ms",
    timestamp = os.date("!*t"),
    kind = "absolute",
    tags = {
      host = "my.host.example"
    },
    aggregated_histogram = {
      buckets = {1.0, 2.0, 4.0, 8.0, 16.0, 32.0},
      counts = {20, 10, 45, 12, 18, 92},
      count = 197,
      sum = 975.2
    }
  }
}
```

</TabItem>
<TabItem value="aggregated_summary">

```lua
event = {
  metric = {
    name = "response_time_ms",
    timestamp = os.date("!*t"),
    kind = "absolute",
    tags = {
      host: "my.host.example"
    },
    aggregated_sumary = {
      quantiles = {0.1, 0.25, 0.5, 0.9, 0.99, 1.0},
      values = {2.0, 3.0, 5.0, 8.0, 9.0, 10.0},
      count = 197,
      sum = 975.2
    }
  }
}
```

</TabItem>
</Tabs>

### Iterate over fields

To iterate over all fields of an `event` use the [`pairs`][urls.lua_pairs] method.  For example:

```lua
function (event, emit)
  # Remove all fields where the value is "-"
  for f, v in pairs(event) do
    if v == "-" then
      event[f] = nil
    end
  end

  emit(event)
end
```

### Search Directories

Vector provides a [`search_dirs`](#search_dirs) option that allows you to specify absolute
paths that will searched when using the [Lua `require`
function][urls.lua_require].

### Lua Version

Vector uses the [`rlua` Rust crate][urls.rlua] which currently embeds Lua 5.3.

### Learning Lua

In order to write non-trivial transforms in Lua, one has to have basic
understanding of Lua. Because Lua is an easy to learn language, reading a few
first chapters of [the official book][urls.lua_pil] or consulting
[the manual][urls.lua_manual] would suffice.


[docs.about.data-model.log]: /docs/about/data-model/log/
[docs.about.data-model.metric]: /docs/about/data-model/metric/
[docs.configuration#environment-variables]: /docs/setup/configuration/#environment-variables
[docs.data-model.log]: /docs/about/data-model/log/
[docs.data-model.metric]: /docs/about/data-model/metric/
[docs.sources.stdin]: /docs/reference/sources/stdin/
[urls.externally_tagged_representation]: https://serde.rs/enum-representations.html#externally-tagged
[urls.lua]: https://www.lua.org/
[urls.lua_manual]: https://www.lua.org/manual/5.3/manual.html
[urls.lua_pairs]: https://www.lua.org/manual/5.3/manual.html#pdf-pairs
[urls.lua_pil]: https://www.lua.org/pil/
[urls.lua_require]: https://www.lua.org/manual/5.3/manual.html#pdf-require
[urls.rlua]: https://github.com/kyren/rlua
